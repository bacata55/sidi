var base="sissh";var map;var pL;var fromProjection;var toProjection;var af="ajax_data.php";var url=af+"?object=getProysMapa4w";var urlr=af+"?object=reportesConteo4w";var urll=urlj=url;var urlmap="http://"+document.location.host+"/"+base+"/consulta/mapserver_p4w.php?";var urlm=urlmap;var urlficha="/"+base+"/perfiles/4w_ficha_";var url_filtros=af+"?object=setFiltrosProysMapa4w";var features;var strategies;var _strategies;var Style;var mtipo;var clear=true;var request=true;var filtro="periodo";var h=new Date();var y=h.getFullYear();var id_filtro=y;var nump_list=15;var mradius=0;var markerRadius=5;var id_depto="00";var rm_id_depto=false;var id_tema=id_org=0;var periodo="";var myCenter;var myZoom=0;var zoomDepto=false;var txt_total_proyectos="Total de proyectos en Colombia";var html_proys;var srp=-1;var si;var grupo="";$j(function(){url+="&si="+si});function initMap(b){mtipo=b;fromProjection=new OpenLayers.Projection("EPSG:4326");toProjection=new OpenLayers.Projection("EPSG:900913");OpenLayers.ImgPath="images/openlayers/";strategies=[new OpenLayers.Strategy.Cluster({distance:50})];map=new OpenLayers.Map({div:"map",displayProjection:toProjection,theme:"style/openlayers/theme/default/style.min.css"});addBaseLayer(b);var a=new OpenLayers.Control.LoadingPanel();map.addControl(a)}function onPopupClose(a){selectControl.unselect(selectedFeature)}function onFeatureUnselect(a){}function onFeatureSelect(a){clear=true;var b="";for(i in a.cluster){if(i>0){b+=","}b+=a.cluster[i].attributes.desc}urll=addURLParameter(url,[["f","lista"],["c","proy"],["id",b],["ini",0]]);addProysToList(urll);$j("#tabs").tabs("enable",2);if(i<nump_list){$j(".masp").hide()}}function setDeptoCenter(c,b){var a=new OpenLayers.LonLat(c,b);a.transform(fromProjection,map.getProjectionObject());myCenter=a;zoomDepto=true}function addBaseLayer(e){myZoom=0;switch(e){case"f":map.maxExtent=new OpenLayers.Bounds(-8099122,-471155,-7441396,1505171);map.projection=toProjection;if(map.getLayersByName("Openstreetmap").length==0){var a=[2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254];var d=new OpenLayers.Layer.XYZ("Openstreetmap",["http://otile1.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png","http://otile3.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png","http://otile4.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png"],{attribution:"Provided by <a href='http://www.mapquest.com/'  target='_blank'>MapQuest</a>, <a href='http://www.openstreetmap.org/' target='_blank'>Open Street Map</a> and contributors, <a href='http://creativecommons.org/licenses/by-sa/2.0/' target='_blank'>CC-BY-SA</a>  <img src='http://developer.mapquest.com/content/osm/mq_logo.png' border='0'>",transitionEffect:"resize",zoomOffset:6,sphericalMercator:true,resolutions:a});map.addLayer(d)}else{map.getLayersByName("Openstreetmap")[0].setVisibility(true)}map.setBaseLayer(map.getLayersByName("Openstreetmap")[0]);var b=new OpenLayers.Style({pointRadius:"${radius}",fillColor:"#133ADA",label:"${label}",fontColor:"#ffffff",fillOpacity:"0.8",strokeColor:"#6999FF",strokeWidth:"5",strokeOpacity:0.5,fontSize:10},{context:{label:function(c){if(c.cluster){ids=countFeaturesCluster(c);return(ids.length>1)?ids.length:""}},width:function(c){return(c.cluster)?2:1},count:function(c){if(c.attributes.count<2){return 2*markerRadius}else{if(c.attributes.count==2){return(Math.min(c.attributes.count,7)+1)*(markerRadius*0.8)}else{return(Math.min(c.attributes.count,7)+1)*(markerRadius*0.6)}}},radius:function(c){ids=countFeaturesCluster(c);feature_count=(ids.length>1)?ids.length:1;if(feature_count>500){return markerRadius*7}else{if(feature_count>400){return markerRadius*6.4}else{if(feature_count>300){return markerRadius*6.1}else{if(feature_count>200){return markerRadius*5.8}else{if(feature_count>100){return markerRadius*5.3}else{if(feature_count>90){return markerRadius*4.8}else{if(feature_count>80){return markerRadius*4.5}else{if(feature_count>70){return markerRadius*4.1}else{if(feature_count>60){return markerRadius*3.8}else{if(feature_count>50){return markerRadius*3.5}else{if(feature_count>40){return markerRadius*3.2}else{if(feature_count>30){return markerRadius*2.9}else{if(feature_count>20){return markerRadius*2.6}else{if(feature_count>10){return markerRadius*2.3}else{return markerRadius*2}}}}}}}}}}}}}}}}});Styles=new OpenLayers.StyleMap({"default":b,select:{fillColor:"#8aeeef",strokeColor:"#32a8a9"}});break;case"t":map.maxExtent=new OpenLayers.Bounds(-81.7227,-4.21785,-66.8755,13.3892);map.projection=fromProjection;break}myCenter=map.maxExtent.getCenterLonLat()}function countFeaturesCluster(b){var d=[];for(var a=0;a<b.cluster.length;a++){var e=true;for(var c=0;c<d.length;c++){if(b.cluster[a].attributes.desc==d[c]){e=false}}if(e){d.push(b.cluster[a].attributes.desc)}}if(d.length>mradius){mradius=d.length}return d}function addMapserverLayer(b,a){var e=urld="";if(id_depto!="00"&&!rm_id_depto){urld="&id_depto_filtro="+id_depto}if(map.layers.length>0){if(map.getLayersByName("Openstreetmap").length>0){map.getLayersByName("Openstreetmap")[0].setVisibility(false)}if(map.getLayersByName("Proyectos").length>0){map.getLayersByName("Proyectos")[0].setVisibility(false)}if(request){if(map.getLayersByName("Consulta").length>0){map.removeLayer(map.getLayersByName("Consulta")[0],false)}}if(b=="proy"){e=a}}if(request||map.getLayersByName("Consulta").length==0){if(b!=undefined&&b!="todos"&&a!=undefined&&b!=""&&a!=""){urlm=addURLParameter(urlm,[["filtro",b],["id_filtro",a],["id_proy",e]])}var c=new OpenLayers.Layer.WMS("Consulta",urlm+urld,{layers:"mpios"},{singleTile:true,ratio:1});map.addLayer(c);map.setBaseLayer(c)}else{var d=map.getLayersByName("Consulta")[0];map.setBaseLayer(d)}}function addProysToMap(d,b,a){url=addURLParameter(url,[["si",si]]);urlmap=addURLParameter(urlmap,[["si",si]]);if(grupo!=""){url=addURLParameter(url,[["grupo",grupo]]);urlmap=addURLParameter(urlmap,[["grupo",grupo]])}urlm=urlmap;urlj=urll=url;urlj=urll;filtro=b;id_filtro=a;urll=addURLParameter(urll,[["f","lista"]]);if(b!=undefined&&a!=undefined&&b!=""&&a!=""){urll=addURLParameter(urll,[["c",b],["id",a],["ini",0]])}if(id_depto!="00"&&!rm_id_depto){urll=addURLParameter(urll,[["id_depto_filtro",id_depto]])}urll=addURLParameter(urll,[["srp",srp]]);myZoom=0;if(zoomDepto){myZoom=2}map.setCenter(myCenter,myZoom);if(b!="proy"){addProysToList(urll)}switch(d){case"f":if(request||map.getLayersByName("Proyectos").length==0){urlj=addURLParameter(urlj,[["f","mapa"]]);if(b!=undefined&&a!=undefined&&b!=""&&a!=""){urlj=addURLParameter(urlj,[["c",b],["id",a]])}if(id_depto!="00"&&!rm_id_depto){urlj=addURLParameter(urlj,[["id_depto_filtro",id_depto]])}urlj=addURLParameter(urlj,[["srp",srp]]);$j.getJSON(urlj,function(e){var c=new OpenLayers.Format.GeoJSON({internalProjection:toProjection,externalProjection:fromProjection});features=c.read(e);addLayerpL();if(id_depto!="00"){}})}else{map.getLayersByName("Proyectos")[0].setVisibility(true)}break;case"t":addMapserverLayer(b,a);break}}function addProysToList(a){$j.ajax({url:a,success:function(b){if(!clear){b=$j("#proys > #c").html()+b}$j("#proys > #c").html(b);$j(".masp").show();if($j("#proys div.row_proy").length<15||(String($j("#proys div.row_proy").length).substr(-1)!="0"&&String($j("#proys div.row_proy").length).substr(-1)!="5")){$j(".masp").hide()}changeTotales()}})}function addLayerpL(){if(map.getLayersByName("Proyectos").length==1){map.removeLayer(pL)}pL=new OpenLayers.Layer.Vector("Proyectos",{styleMap:Styles,strategies:strategies});map.addLayer(pL);if(mradius>0){mradius=0;for(var b=0;b<features.length;b++){if(features[b].attributes.count>mradius){mradius=features[b].attributes.count}}}pL.addFeatures(features);highlightControl=new OpenLayers.Control.SelectFeature(pL,{hover:true,highlightOnly:true});map.addControl(highlightControl);highlightControl.activate();var a=new OpenLayers.Control.SelectFeature(pL,{clickout:true,onSelect:onFeatureSelect,onUnselect:onFeatureUnselect});map.addControl(a);a.activate()}function addFiltertoList(p,m,o,a,g){var f=true;var l="div_tt_"+o;var b=l+"_span_"+a;var e=0;var j=true;if(g===undefined){g=true}p=" "+p;s=' <img src="images/p4w/remove.gif" /> ';$j("#titulo").find("h1").each(function(c){if($j(this).html()==p){j=false}});if(j){$j("#titulo").find("h2").each(function(c){if($j(this).html()==m){f=false;e=c;m=""}});var u='<span id="'+b+'" data-c="'+o+'" data-id="'+a+'" data-divp="'+l+'" class="eliminar">'+s+"</span>";if($j("#titulo > div.tt").find("h1").html()==txt_total_proyectos){$j("#titulo").find("h1").html("");$j("#titulo").find("h2").html("")}var d=u+"<h1>"+p+"</h1>";var k="";var r=$j("#titulo");if(f){var n=r.find("div.tt:first").clone();k="<h2>"+m+"</h2>"+d;n.attr("id",l);n.html(k);n.appendTo("#titulo")}else{k=d;$j("#"+l).append(k)}var q=url_filtros;if(o=="periodo"){q=addURLParameter(q,[["c",o]]);q=addURLParameter(q,[["periodo_que",getPeriodoQue()]])}addFilterSession(o,a,q);$j("span#"+b).click(function(){clear=true;request=true;if(o=="id_depto_filtro"){rm_id_depto=true;$j("#depto").val("00|0,0")}else{}var v=$j(this).attr("data-id");var c=$j(this).attr("data-c");var x=$j(this).attr("data-divp");removeFilterSession(c,v);if(c=="id_depto_filtro"){zoomDepto=false}$j(this).next().remove();$j(this).remove();var w=$j("#"+x);if(w.find("h1").length==0){w.remove()}if($j("#titulo").find("div.tt").length==1){$j("#titulo").find("h1").html(txt_total_proyectos);$j("#titulo").find("h2").html("");$j("#titulo").find("span").html("")}filterMapLive()});if(g){filterMapLive()}}}function filterMapLive(){setTimeout(function(){addProysToMap(mtipo,"","");changeTotales()},500)}function changeTitulo(e,d,k,j){var a=true;var f="div_tt_"+k;var b=0;s="[ Eliminar Filtro ]";$j("#titulo, #resumen").show("slow");$j("#titulo").find("h2").each(function(c){if($j(this).html()==d||$j(this).html()=="Proyectos"){a=false;b=c}});var g=(a)?$j("#titulo > div.tt:first").clone():$j("#titulo > div.tt:eq("+b+")");g.find("h2").html(d);g.find("h1").html(e);g.find("span").html(s);g.attr("id",f);g.find("span").click(function(){clear=true;request=true;if(k=="id_depto_filtro"){rm_id_depto=true;$j("#depto").val("00|0,0")}else{}if($j("#titulo > div.tt").length>1){$j("#"+f).remove()}else{$j("#titulo").find("h1").html("Colombia");$j("#titulo").find("h2").html("Proyectos");$j("#titulo").find("span").html("")}});if(a){g.appendTo("#titulo")}}function changeTotales(){$j("#npro_h2").html($j("#proys").find("#4w_np").val());$j("#norg_h2").html($j("#proys").find("#4w_no").val());$j("#nimp_h2").html($j("#proys").find("#4w_ni").val());$j("#nbenef_h2").html($j("#proys").find("#4w_nb").val());$j("#npres_h2").html($j("#proys").find("#4w_npres").val());$j("#npres_gob_h2").html($j("#proys").find("#4w_npres_gob").val());$j("#npres_sin_donante_h2").html($j("#proys").find("#4w_npres_sin_donante").val());$j("#npres_total_h2").html($j("#proys").find("#4w_npres_total").val());var b=["cluster","donantes","deptos","ejecutoras"];for(var a=0;a<b.length;a++){t=b[a];html=$j("textarea#resumen_top_"+t).val();$div=$j("#p4w").find("div#top_"+t);if(html!=""){$div.show();$div.html(html)}else{$div.hide()}}if(request){$j("div.f").not("div.f.c").each(function(){$j("div#"+$j(this).attr("id")).find("div.c").html($j("div#fcu_"+$j(this).attr("id")).html())});addEventosFiltros()}}function addEventosGrupos(){$j(".ingresar").click(function(){var a=$j(this).attr("id");addFiltertoList("Vigentes en: "+y,"Periodo","periodo",y,false);if(si=="4w"){$j("#m_grupos_select").val(a);grupo=a}else{ida=a.split(",");fa=$j(this).data("filtro").split(",");if($j("#div_tt_cluster").length>0){removeFilterSession("cluster",0);$j("#div_tt_cluster").remove()}if(fa[0]!="des"){for(i in ida){addFiltertoList(fa[i],"Resultado","cluster",ida[i],false)}}}filterMapLive();$j("div#grupos").hide();$j("#todo, #map").show()})}function grupoProys(a){request=clear=true;si=a;addProysToMap(mtipo,"","")}function clickTodos(){$j(".masp").show();addProysToMap(mtipo,"todos","1")}function addEventos(a){addEventosFiltros();$j("#applyFiltros").click(function(){grupo=$j("#m_grupos_select").val();addProysToMap(mtipo,"","");changeTotales();return false});$j("#btn_srp").click(function(){$div=$j(this).closest("div");if($div.hasClass("srp_off")){srp=1;$div.removeClass("srp_off");$div.addClass("srp_on");addFilterSession("srp",1,url_filtros)}else{srp=-1;$div.addClass("srp_off");$div.removeClass("srp_on");removeFilterSession("srp",1)}addProysToMap(mtipo,"","");changeTotales();return false});$j("#todos").click(function(){clickTodos()});$j("#proys_order").change(function(){urll=addURLParameter(urll,[["order",$j(this).val()]]);addProysToList(urll)});$j("#proys_limit").click(function(){urll=addURLParameter(urll,[["limit","no"]]);addProysToList(urll)});$j(".masp").show();$j(".masp > .boton").click(function(){clear=false;urll=addURLParameter(urll,[["ini",$j("#proys").find("div.row_proy").length]]);addProysToList(urll)});$j("#proys .csv").click(function(){location.href="/sissh/export_data.php?csv2xls&nombre_archivo=proyectos_4w&csv_path=/sissh/static/4w/proyectos_4w.csv"});$j("#filtros div.g a").click(function(){var b="#"+$j(this).attr("rel");$j("div.f").not(b).hide();$j(b).slideToggle("slow")});$j("#fmenu ul li.f a").each(function(){$j(this).click(function(){$j("div.f").each(function(){$j(this).hide()});$j("div#"+$j(this).attr("rel")).show()})});$j("div#reportes a.ft").click(function(){var b=$j(this).parent("div#reportes").find("div.c");var c=b.find('div.row:contains("Municipal")');b.toggle("slow")});$j("div#reportes").find("div.col").each(function(){var b=$j(this).attr("id");$j(this).find("div.fila").each(function(){$j(this).click(function(){$j(this).parents("div.col").find("div.fila").removeClass("selected");$j(this).toggleClass("selected");checkParamsReporte()})})});$j(".mapa_f").click(function(){mtipo="f";$j(".mapa_t").removeClass("active");$j(this).addClass("active");$j("#map").addClass("mapfull");addBaseLayer(mtipo);$j("#mapas_o").find(".save").hide("slow")});$j(".mapa_t").click(function(){mtipo="t";$j(".mapa_f").removeClass("active");$j(this).addClass("active");$j("#map").removeClass("mapfull");addBaseLayer(mtipo);$j("#mapas_o").find(".save").show("slow")});$j("#mapas_o .save").click(function(){location.href="consulta/mapserver_download_img.php"});$j(".close").click(function(){$j(this).parent("div.p").hide()});$j("#footer div.g a.ft").each(function(){$j(this).click(function(){$j("#"+$j(this).attr("rel")).slideToggle("slow")})});$j("#proys").on("click","div.t",function(){clear=true;request=true;var b=$j(this).attr("id");$div_c=$j("#proys > #c");html_proys=$div_c.html();addProysToMap(mtipo,"proy",b);$div_c.html($j("div#ficha_"+b).html());$j(".masp").hide();$j(".proys_order").hide();$div_c.prepend('<div><br /><a id="regresar_lista" onClick="regresarLista()" href="#">&laquo; Regresar a la lista</a></div>')});$j("#proys").on("click","span.s",function(){clear=true;request=true;var b=$j(this).attr("id");addProysToMap(mtipo,"ejecutora",b);changeTitulo($j(this).html(),"Ejecutora")});$j("#proys").on("click","span.tema",function(){clear=true;request=true;var c=$j(this).attr("id");var b=$j(this).attr("class").split(" ")[1];var d=[0,"si","cluster"];var e=[0,"UNDAF","Cluster"];addProysToMap(mtipo,d[b],c);changeTitulo($j(this).html(),e[b])})}function addEventosFiltros(){var a=[];a.cluster="Cluster";a.si="UNDAF";a.ejecutora="Ejecutora";a.implementadora="Implementadora";a.donante="Donante";a.estado="Estado";a.periodo="Periodo";a.ubicacion="Departamento";for(var b in a){$j("#filtros").find("div.f"+b).each(function(){$j(this).click(function(){clear=true;request=true;$j("div.row").removeClass("selected");$j(this).addClass("selected");var g=$j(this).attr("class").split(" ")[1].substr(1);if(g=="ubicacion"){var g="id_depto_filtro";var e=_ii="";var c="Departamento";var d=$j(this).find("span.nom").html();id_depto=$j(this).attr("id");if(mtipo=="f"){setDeptoCenter($j(this).attr("lon"),$j(this).attr("lat"))}$j("#btn_fpdf > a").html("Ficha Departamental");addFiltertoList(d,c,"id_depto_filtro",id_depto)}else{zoomDepto=false;var g=$j(this).attr("class").split(" ")[1].substr(1);var e=$j(this).attr("id");var d=$j(this).find("span.nom").html();if(g=="periodo"){periodo=e;var f={i:"Inician",f:"Finalizan",v:"Vigentes"};d=f[getPeriodoQue()]+" en: "+d}addFiltertoList(d,a[g],g,e)}hideFiltros()})})}}function applyFiltros(f,c,g,b,a,e,d){addProysToMap(f,c,g);changeTitulo(b,a,e,d)}function hideFiltros(){$j("#filtros div.f").slideUp("slow")}function checkParamsReporte(){var a=false;var c=0;var b=[["si",si]];$j("div#reportes").find("div#sub").hide();$j("div#reportes").find("div.col").each(function(){var d=$j(this).attr("id");$j(this).find("div.fila").each(function(){if($j(this).hasClass("selected")){c++;b.push([d.substr(1),$j(this).attr("title")])}})});if(c>=3){urlr=addURLParameter(urlr,b);$j("div#reportes").find("div#sub > div.csv").unbind().click(function(){var d=$j("#reportes h3").html();$j("#reportes h3").html('<img src="images/p4w/loading.gif" />&nbsp;Generando reporte....</div>');$j.ajax({url:urlr,success:function(){$j("#reportes h3").html(d);location.href="/sissh/export_data.php?csv2xls&nombre_archivo=4w_reporte_conteo&csv_path=/tmp/4w_reporte_conteo.csv"}})});$j("div#reportes").find("div#sub").show()}}function filterList(b,c){texto=$j(b.target).val();keyNum=b.keyCode;if(keyNum==8){texto=texto.slice(0,-1)}else{keyChar=String.fromCharCode(keyNum);texto+=keyChar}var a=new RegExp(texto,"i");$j(b.target).parents("div#"+c).find("div.fila").each(function(){$j(this).show();if(!$j(this).find("div.nom").text().match(a)){$j(this).hide()}})}function getPeriodoQue(){return $j("input[name=periodo_que]:checked").val()}function regresarLista(){$j("#proys").find("#c").html(html_proys);return false}function removeFilterSession(b,a){$j.ajax({url:url_filtros+"&c=-"+b+"&id="+a})}function addFilterSession(d,b,a){$j.ajax({url:a+"&c="+d+"&id="+b})};